name: Tests de Non-RÃ©gression

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  regression-tests:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: bonea2024
          POSTGRES_USER: zalint
          POSTGRES_DB: mata_expenses_test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      DB_HOST: localhost
      DB_PORT: 5432
      DB_NAME: mata_expenses_test_db
      DB_USER: zalint
      DB_PASSWORD: bonea2024
      NODE_ENV: test

    steps:
    - name: ğŸ“‹ Checkout du code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Installation des dÃ©pendances
      run: npm ci

    - name: ğŸ—ï¸ Initialisation de la base de donnÃ©es de test
      run: |
        # VÃ©rifier que le fichier SQL existe
        if [ ! -f "github_test_database_setup.sql" ]; then
          echo "âŒ Fichier github_test_database_setup.sql non trouvÃ©"
          ls -la *.sql
          exit 1
        fi
        
        echo "âœ… Fichier github_test_database_setup.sql trouvÃ©"
        echo "ğŸ“ Taille du fichier:"
        wc -l github_test_database_setup.sql
        
        # Utiliser le script complet de setup de la base de donnÃ©es
        echo "ğŸ”„ ExÃ©cution du script de setup..."
        PGPASSWORD=$DB_PASSWORD psql -h localhost -U $DB_USER -d $DB_NAME -f github_test_database_setup.sql
        
        echo "âœ… Setup de la base de donnÃ©es terminÃ©"

    - name: ğŸ§ª ExÃ©cution des tests de base
      run: npm run test

    - name: ğŸ§ª ExÃ©cution des tests de rÃ©gression
      run: npm run test:regression

    - name: ğŸ“Š Rapport de couverture
      run: |
        echo "âœ… Tests de non-rÃ©gression terminÃ©s avec succÃ¨s!"
        echo "ğŸ“‹ RÃ©sumÃ©:"
        echo "  â€¢ Test 1: Ajout dÃ©pense 1000 FCFA"
        echo "  â€¢ Test 2: Suppression dÃ©pense 1000 FCFA"
        echo "  â€¢ Test 3: Ajout crÃ©ance 500 FCFA"
        echo "  â€¢ Test 4: Suppression crÃ©ance 500 FCFA"  
        echo "  â€¢ Test 5: Ajout transfert 750 FCFA"
        echo "  â€¢ Test 6: Suppression transfert 750 FCFA"
        echo "  â€¢ Test 19: CohÃ©rence colonnes transferts"
        echo "  â€¢ VÃ©rification: Solde actuel = Solde Net"
        echo "  â€¢ VÃ©rification: Audit Flux = Solde Net"
        echo "  â€¢ VÃ©rification: Transferts automatiquement synchronisÃ©s"

    - name: ğŸ“§ Notification en cas d'Ã©chec
      if: failure()
      run: |
        echo "âŒ Ã‰CHEC DES TESTS DE RÃ‰GRESSION!"
        echo "Les tests de cohÃ©rence des comptes ont Ã©chouÃ©."
        echo "VÃ©rifiez les calculs de solde et la logique des transactions."
        exit 1
